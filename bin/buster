#!/bin/bash
set -eu
BUSTER_PATH="$(dirname $(realpath "${BASH_SOURCE[0]}/.."))"
BUSTER_EXT=${BUSTER_PATH}/ext
BUSTER_SRC=${BUSTER_PATH}/src
BUSTER_TMP=${BUSTER_PATH}/tmp
BUSTER_PLATFORM="$(echo "$(uname -s)-$(uname -m)" | tr '[:upper:]' '[:lower:]')"
BUSTER_NODE_VERSION=22.12.0
BUSTER_ESBUILD_VERSION=0.24.0
BUSTER_TYPESCRIPT_VERSION=5.7.4

BUSTER_NODE_IDENTIFIER="node-v${BUSTER_NODE_VERSION}-${BUSTER_PLATFORM}"
BUSTER_ESBUILD_IDENTIFIER="esbuild-v${BUSTER_ESBUILD_VERSION}-${BUSTER_PLATFORM}"
BUSTER_TYPESCRIPT_IDENTIFIER="typescript-v${BUSTER_TYPESCRIPT_VERSION}-${BUSTER_PLATFORM}"

# Ensure bin
mkdir -p ${BUSTER_EXT}

# Bootstrap node
if [ ! -d "${BUSTER_EXT}/${BUSTER_NODE_IDENTIFIER}" ]; then
  mkdir ${BUSTER_TMP}
  pushd ${BUSTER_TMP} > /dev/null
  wget -q https://nodejs.org/dist/v${BUSTER_NODE_VERSION}/${BUSTER_NODE_IDENTIFIER}.tar.gz
  tar xzf ${BUSTER_NODE_IDENTIFIER}.tar.gz
  rm ${BUSTER_NODE_IDENTIFIER}.tar.gz
  mv ${BUSTER_NODE_IDENTIFIER} ${BUSTER_EXT}
  popd > /dev/null
  rm -rf ${BUSTER_TMP}
fi

BUSTER_HASH=$(${BUSTER_EXT}/${BUSTER_NODE_IDENTIFIER}/bin/node ${BUSTER_SRC}/hash.js "BUSTER_NODE_VERSION=${BUSTER_NODE_VERSION} BUSTER_ESBUILD_VERSION=${BUSTER_ESBUILD_VERSION} BUSTER_TYPESCRIPT_VERSION=${BUSTER_TYPESCRIPT_VERSION}")
echo ${BUSTER_HASH}
exit

# Bootstrap esbuild
if [ ! -d "${BUSTER_EXT}/${BUSTER_ESBUILD_IDENTIFIER}" ]; then
  mkdir ${BUSTER_TMP}
  pushd ${BUSTER_TMP} > /dev/null
  ${BUSTER_EXT}/${BUSTER_NODE_IDENTIFIER}/bin/npm i --quiet --prefix . esbuild@${BUSTER_ESBUILD_VERSION}
  mkdir -p ${BUSTER_TMP}/${BUSTER_ESBUILD_IDENTIFIER}
  mv ${BUSTER_TMP}/node_modules/@esbuild ${BUSTER_TMP}/${BUSTER_ESBUILD_IDENTIFIER}
  mv ${BUSTER_TMP}/node_modules/esbuild ${BUSTER_TMP}/${BUSTER_ESBUILD_IDENTIFIER}
  mv ${BUSTER_ESBUILD_IDENTIFIER} ${BUSTER_EXT}
  popd > /dev/null
  rm -rf ${BUSTER_TMP}
fi

# Bootstrap TypeScript
if [ ! -d "${BUSTER_EXT}/${BUSTER_TYPESCRIPT_IDENTIFIER}" ]; then
  mkdir ${BUSTER_TMP}
  pushd ${BUSTER_TMP} > /dev/null
  ${BUSTER_EXT}/${BUSTER_NODE_IDENTIFIER}/bin/npm i --quiet --prefix . typescript@${BUSTER_TYPESCRIPT_VERSION}
  mv ${BUSTER_TMP}/node_modules/typescript ${BUSTER_EXT}/${BUSTER_TYPESCRIPT_IDENTIFIER}
  popd > /dev/null
  rm -rf ${BUSTER_TMP}
fi

BUSTER_PATH=${BUSTER_PATH} \
BUSTER_NODE_VERSION=${BUSTER_NODE_VERSION} \
BUSTER_ESBUILD_VERSION=${BUSTER_ESBUILD_VERSION} \
BUSTER_TYPESCRIPT_VERSION=${BUSTER_TYPESCRIPT_VERSION} \
  ${BUSTER_EXT}/${BUSTER_NODE_IDENTIFIER}/bin/node --import ${BUSTER_SRC}/register.js $*

