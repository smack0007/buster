#!/bin/bash
set -eu
BUSTER_PATH="$(dirname $(realpath "${BASH_SOURCE[0]}/.."))"
BUSTER_DEPS=${BUSTER_PATH}/deps
BUSTER_SRC=${BUSTER_PATH}/src
BUSTER_TMP=${BUSTER_PATH}/tmp
BUSTER_PLATFORM="$(echo "$(uname -s)-$(uname -m)" | tr '[:upper:]' '[:lower:]')"
BUSTER_NODE_VERSION=22.12.0
BUSTER_ESBUILD_VERSION=0.24.0
BUSTER_TYPESCRIPT_VERSION=5.7.2

BUSTER_NODE_IDENTIFIER="node-v${BUSTER_NODE_VERSION}-${BUSTER_PLATFORM}"
BUSTER_NODE_PATH="${BUSTER_DEPS}/${BUSTER_NODE_IDENTIFIER}/bin/node"

# Ensure deps and remove tmp if it exists
mkdir -p ${BUSTER_DEPS}
if [ -d "${BUSTER_TMP}" ]; then
  rm -rf ${BUSTER_TMP}
fi

# Bootstrap node
if [ ! -d "${BUSTER_DEPS}/${BUSTER_NODE_IDENTIFIER}" ]; then
  mkdir -p ${BUSTER_TMP}
  pushd ${BUSTER_TMP} > /dev/null
  wget -q https://nodejs.org/dist/v${BUSTER_NODE_VERSION}/${BUSTER_NODE_IDENTIFIER}.tar.gz
  tar xzf ${BUSTER_NODE_IDENTIFIER}.tar.gz
  rm ${BUSTER_NODE_IDENTIFIER}.tar.gz
  mv ${BUSTER_NODE_IDENTIFIER} ${BUSTER_DEPS}
  popd > /dev/null
  rm -rf ${BUSTER_TMP}
fi

BUSTER_NODE_MODULES_HASH=$(${BUSTER_NODE_PATH} ${BUSTER_SRC}/hash.js "BUSTER_NODE_VERSION=${BUSTER_NODE_VERSION} BUSTER_ESBUILD_VERSION=${BUSTER_ESBUILD_VERSION} BUSTER_TYPESCRIPT_VERSION=${BUSTER_TYPESCRIPT_VERSION}")
BUSTER_NODE_MODULES_IDENTIFIER="node_modules-${BUSTER_NODE_MODULES_HASH}"
BUSTER_NODE_MODULES_PATH="${BUSTER_DEPS}/${BUSTER_NODE_MODULES_IDENTIFIER}"

# Bootstrap node_modules
if [ ! -d "${BUSTER_DEPS}/${BUSTER_NODE_MODULES_IDENTIFIER}" ]; then
  mkdir -p ${BUSTER_TMP}
  pushd ${BUSTER_TMP} > /dev/null
  ${BUSTER_DEPS}/${BUSTER_NODE_IDENTIFIER}/bin/npm i --quiet --prefix . esbuild@${BUSTER_ESBUILD_VERSION} typescript@${BUSTER_TYPESCRIPT_VERSION} > /dev/null
  mv node_modules ${BUSTER_NODE_MODULES_PATH}
  popd > /dev/null
  rm -rf ${BUSTER_TMP}
fi

BUSTER_NODE_MODULES_PATH=${BUSTER_NODE_MODULES_PATH} \
  ${BUSTER_NODE_PATH} --import ${BUSTER_SRC}/loader.js $*

